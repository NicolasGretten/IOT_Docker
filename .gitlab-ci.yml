stages:
  - staging-pull
  - production-pull
  - images
  - staging-build
  - staging-test
  - staging-code-quality
  - staging-scan
  - staging-deploy
  - production-build
  - production-test
  - production-code-quality
  - production-scan
  - production-deploy
  - rabbitmq
  - proxy

staging-pull-job:
  stage: staging-pull
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
  tags:
    - staging
  script:
    - echo "PULL JOB"
  after_script:
    - cd /home/admin/docker.collect.verything && sudo git reset --hard origin/staging && sudo git pull origin staging

staging_image_php:
  stage: images
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "images/php8.1-fpm/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/images/php8.1-fpm && sudo docker build -t collectandverything-php .

staging_image_nginx:
  stage: images
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "images/nginx-alpine/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/images/nginx-alpine && sudo docker build -t collectandverything-nginx .

staging_image_react:
  stage: images
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "images/react/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/images/react && sudo docker build -t collectandverything-react .

staging_build_address:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "address/*"
        - "address/*/*"
        - "address/*/*/*"
  environment:
    name: staging
    url: https://staging.api.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/address && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_address:
  stage: staging-test
  needs: [staging_build_address]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "address/*"
        - "address/*/*"
        - "address/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name address-test-php collectandverything-address:latest
    - sudo docker exec address-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f address-test-php

staging_code_quality_address:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_address]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "address/*"
        - "address/*/*"
        - "address/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name address-test-php collectandverything-address:latest
    - sudo docker exec address-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp address-test-php:/var/www/output.xml phpcs-address.xml
  after_script:
    - sudo docker rm -f address-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_address:
  stage: staging-scan
  needs: [staging_build_address]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "address/*"
        - "address/*/*"
        - "address/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-address:latest

staging_deploy_address:
  stage: staging-deploy
  needs: [staging_test_address]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "address/*"
        - "address/*/*"
        - "address/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/address && sudo -E docker compose up -d

staging_build_admin:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "admin/*"
        - "admin/*/*"
        - "admin/*/*/*"
  environment:
    name: staging
    url: https://staging.api.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/admin && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_admin:
  stage: staging-test
  needs: [staging_build_admin]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "admin/*"
        - "admin/*/*"
        - "admin/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name admin-test-php collectandverything-admin:latest
    - sudo docker exec admin-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f admin-test-php

staging_code_quality_admin:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_admin]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "admin/*"
        - "admin/*/*"
        - "admin/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name admin-test-php collectandverything-admin:latest
    - sudo docker exec admin-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp admin-test-php:/var/www/output.xml phpcs-admin.xml
  after_script:
    - sudo docker rm -f admin-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_admin:
  stage: staging-scan
  needs: [staging_build_admin]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "admin/*"
        - "admin/*/*"
        - "admin/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-admin:latest

staging_deploy_admin:
  stage: staging-deploy
  needs: [staging_test_admin]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "admin/*"
        - "admin/*/*"
        - "admin/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/admin && sudo -E docker compose up -d

staging_build_api:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "api/*"
        - "api/*/*"
        - "api/*/*/*"
  environment:
    name: staging
    url: https://staging.api.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/api && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_api:
  stage: staging-test
  needs: [staging_build_api]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "api/*"
        - "api/*/*"
        - "api/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name api-test-php collectandverything-api:latest
    - sudo docker exec api-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f api-test-php

staging_code_quality_api:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_api]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "api/*"
        - "api/*/*"
        - "api/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name api-test-php collectandverything-api:latest
    - sudo docker exec api-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp api-test-php:/var/www/output.xml phpcs-api.xml
  after_script:
    - sudo docker rm -f api-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_api:
  stage: staging-scan
  needs: [staging_build_api]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "api/*"
        - "api/*/*"
        - "api/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-api:latest

staging_deploy_api:
  stage: staging-deploy
  needs: [staging_test_api]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "api/*"
        - "api/*/*"
        - "api/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/api && sudo -E docker compose up -d

staging_build_boutique:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "boutique/*"
        - "boutique/*/*"
        - "boutique/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/boutique && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache && sudo -E docker compose up -d

staging_build_bill:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "bill/*"
        - "bill/*/*"
        - "bill/*/*/*"
  environment:
    name: staging
    url: https://staging.bill.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/bill && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_bill:
  stage: staging-test
  needs: [staging_build_bill]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "bill/*"
        - "bill/*/*"
        - "bill/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name bill-test-php collectandverything-bill:latest
    - sudo docker exec bill-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f bill-test-php

staging_code_quality_bill:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_bill]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "bill/*"
        - "bill/*/*"
        - "bill/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name bill-test-php collectandverything-bill:latest
    - sudo docker exec bill-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp bill-test-php:/var/www/output.xml phpcs-bill.xml
  after_script:
    - sudo docker rm -f bill-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_bill:
  stage: staging-scan
  needs: [staging_build_bill]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "bill/*"
        - "bill/*/*"
        - "bill/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-bill:latest

staging_deploy_bill:
  stage: staging-deploy
  needs: [staging_test_bill]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "bill/*"
        - "bill/*/*"
        - "bill/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/bill && sudo -E docker compose up -d

staging_build_cart:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "cart/*"
        - "cart/*/*"
        - "cart/*/*/*"
  environment:
    name: staging
    url: https://staging.cart.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/cart && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_cart:
  stage: staging-test
  needs: [staging_build_cart]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "cart/*"
        - "cart/*/*"
        - "cart/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name cart-test-php collectandverything-cart:latest
    - sudo docker exec cart-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f cart-test-php

staging_code_quality_cart:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_cart]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "cart/*"
        - "cart/*/*"
        - "cart/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name cart-test-php collectandverything-cart:latest
    - sudo docker exec cart-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp cart-test-php:/var/www/output.xml phpcs-cart.xml
  after_script:
    - sudo docker rm -f cart-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_cart:
  stage: staging-scan
  needs: [staging_build_cart]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "cart/*"
        - "cart/*/*"
        - "cart/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-cart:lates

staging_deploy_cart:
  stage: staging-deploy
  needs: [staging_test_cart]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "cart/*"
        - "cart/*/*"
        - "cart/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/cart && sudo -E docker compose up -d

staging_build_dashboard:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "dashboard/*"
        - "dashboard/*/*"
        - "dashboard/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/dashboard && sudo -E docker compose build --no-cache && sudo -E docker compose up -d

staging_build_employee:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "employee/*"
        - "employee/*/*"
        - "employee/*/*/*"
  environment:
    name: staging
    url: https://staging.employee.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/employee && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_employee:
  stage: staging-test
  needs: [staging_build_employee]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "employee/*"
        - "employee/*/*"
        - "employee/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name employee-test-php collectandverything-employee:latest
    - sudo docker exec employee-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f employee-test-php

staging_code_quality_employee:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_employee]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "employee/*"
        - "employee/*/*"
        - "employee/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name employee-test-php collectandverything-employee:latest
    - sudo docker exec employee-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp employee-test-php:/var/www/output.xml phpcs-employee.xml
  after_script:
    - sudo docker rm -f employee-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_employee:
  stage: staging-scan
  needs: [staging_build_employee]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "employee/*"
        - "employee/*/*"
        - "employee/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-employee:latest

staging_deploy_employee:
  stage: staging-deploy
  needs: [staging_test_employee]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "employee/*"
        - "employee/*/*"
        - "employee/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/employee && sudo -E docker compose up -d

staging_build_image:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "image/*"
        - "image/*/*"
        - "image/*/*/*"
  environment:
    name: staging
    url: https://staging.image.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/image && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_image:
  stage: staging-test
  needs: [staging_build_image]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "image/*"
        - "image/*/*"
        - "image/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name image-test-php collectandverything-image:latest
    - sudo docker exec image-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f image-test-php

staging_code_quality_image:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_image]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "image/*"
        - "image/*/*"
        - "image/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name image-test-php collectandverything-image:latest
    - sudo docker exec image-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp image-test-php:/var/www/output.xml phpcs-image.xml
  after_script:
    - sudo docker rm -f image-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_image:
  stage: staging-scan
  needs: [staging_build_image]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "image/*"
        - "image/*/*"
        - "image/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-image:latest

staging_deploy_image:
  stage: staging-deploy
  needs: [staging_test_image]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "image/*"
        - "image/*/*"
        - "image/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/image && sudo -E docker compose up -d

staging_build_mail:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "mail/*"
        - "mail/*/*"
        - "mail/*/*/*"
  environment:
    name: staging
    url: https://staging.mail.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/mail && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_mail:
  stage: staging-test
  needs: [staging_build_mail]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "mail/*"
        - "mail/*/*"
        - "mail/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name mail-test-php collectandverything-mail:latest
    - sudo docker exec mail-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f mail-test-php

staging_code_quality_mail:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_mail]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "mail/*"
        - "mail/*/*"
        - "mail/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name mail-test-php collectandverything-mail:latest
    - sudo docker exec mail-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp mail-test-php:/var/www/output.xml phpcs-mail.xml
  after_script:
    - sudo docker rm -f mail-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_mail:
  stage: staging-scan
  needs: [staging_build_mail]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "mail/*"
        - "mail/*/*"
        - "mail/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-mail:latest

staging_deploy_mail:
  stage: staging-deploy
  needs: [staging_test_mail]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "mail/*"
        - "mail/*/*"
        - "mail/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/mail && sudo -E docker compose up -d

staging_build_order:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "order/*"
        - "order/*/*"
        - "order/*/*/*"
  environment:
    name: staging
    url: https://staging.order.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/order && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_order:
  stage: staging-test
  needs: [staging_build_order]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "order/*"
        - "order/*/*"
        - "order/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name order-test-php collectandverything-order:latest
    - sudo docker exec order-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f order-test-php

staging_code_quality_order:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_order]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "order/*"
        - "order/*/*"
        - "order/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name order-test-php collectandverything-order:latest
    - sudo docker exec order-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp order-test-php:/var/www/output.xml phpcs-order.xml
  after_script:
    - sudo docker rm -f order-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_order:
  stage: staging-scan
  needs: [staging_build_order]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "order/*"
        - "order/*/*"
        - "order/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-order:latest

staging_deploy_order:
  stage: staging-deploy
  needs: [staging_test_order]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "order/*"
        - "order/*/*"
        - "order/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/order && sudo -E docker compose up -d

staging_build_product:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "product/*"
        - "product/*/*"
        - "product/*/*/*"
  environment:
    name: staging
    url: https://staging.product.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/product && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_product:
  stage: staging-test
  needs: [staging_build_product]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "product/*"
        - "product/*/*"
        - "product/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name product-test-php collectandverything-product:latest
    - sudo docker exec product-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f product-test-php

staging_code_quality_product:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_product]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "product/*"
        - "product/*/*"
        - "product/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name product-test-php collectandverything-product:latest
    - sudo docker exec product-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp product-test-php:/var/www/output.xml phpcs-product.xml
  after_script:
    - sudo docker rm -f product-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_product:
  stage: staging-scan
  needs: [staging_build_product]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "product/*"
        - "product/*/*"
        - "product/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-product:latest

staging_deploy_product:
  stage: staging-deploy
  needs: [staging_test_product]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "product/*"
        - "product/*/*"
        - "product/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/product && sudo -E docker compose up -d

staging_build_store:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "store/*"
        - "store/*/*"
        - "store/*/*/*"
  environment:
    name: staging
    url: https://staging.store.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/store && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_store:
  stage: staging-test
  needs: [staging_build_store]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "store/*"
        - "store/*/*"
        - "store/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name store-test-php collectandverything-store:latest
    - sudo docker exec store-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f store-test-php

staging_code_quality_store:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_store]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "store/*"
        - "store/*/*"
        - "store/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name store-test-php collectandverything-store:latest
    - sudo docker exec store-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp store-test-php:/var/www/output.xml phpcs-store.xml
  after_script:
    - sudo docker rm -f store-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_store:
  stage: staging-scan
  needs: [staging_build_store]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "store/*"
        - "store/*/*"
        - "store/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-store:latest

staging_deploy_store:
  stage: staging-deploy
  needs: [staging_test_store]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "store/*"
        - "store/*/*"
        - "store/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/store && sudo -E docker compose up -d

staging_build_user:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "user/*"
        - "user/*/*"
        - "user/*/*/*"
  environment:
    name: staging
    url: https://staging.user.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/user && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_user:
  stage: staging-test
  needs: [staging_build_user]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "user/*"
        - "user/*/*"
        - "user/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name user-test-php collectandverything-user:latest
    - sudo docker exec user-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f user-test-php

staging_code_quality_user:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_user]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "user/*"
        - "user/*/*"
        - "user/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name user-test-php collectandverything-user:latest
    - sudo docker exec user-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp user-test-php:/var/www/output.xml phpcs-user.xml
  after_script:
    - sudo docker rm -f user-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_user:
  stage: staging-scan
  needs: [staging_build_user]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "user/*"
        - "user/*/*"
        - "user/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-user:latest

staging_deploy_user:
  stage: staging-deploy
  needs: [staging_test_user]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "user/*"
        - "user/*/*"
        - "user/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/user && sudo -E docker compose up -d

staging_build_payment:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "payment/*"
        - "payment/*/*"
        - "payment/*/*/*"
  environment:
    name: staging
    url: https://staging.payment.collectandverything.fr
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/payment && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache

staging_test_payment:
  stage: staging-test
  needs: [staging_build_payment]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "payment/*"
        - "payment/*/*"
        - "payment/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name payment-test-php collectandverything-payment:latest
    - sudo docker exec payment-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f payment-test-php

staging_code_quality_payment:
  stage: staging-code-quality
  allow_failure: false
  needs: [staging_build_payment]
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "payment/*"
        - "payment/*/*"
        - "payment/*/*/*"
  tags:
    - staging
  script:
    - sudo docker run -d --network=collectandverything --name payment-test-php collectandverything-payment:latest
    - sudo docker exec payment-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp payment-test-php:/var/www/output.xml phpcs-payment.xml
  after_script:
    - sudo docker rm -f payment-test-php
  artifacts:
    paths:
      - "*.xml"

staging_scan_payment:
  stage: staging-scan
  needs: [staging_build_payment]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "payment/*"
        - "payment/*/*"
        - "payment/*/*/*"
  tags:
    - staging
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-payment:latest

staging_deploy_payment:
  stage: staging-deploy
  needs: [staging_test_payment]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "payment/*"
        - "payment/*/*"
        - "payment/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/payment && sudo -E docker compose up -d

staging_build_vitrine:
  stage: staging-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "vitrine/*"
        - "vitrine/*/*"
        - "vitrine/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/vitrine && sudo -E docker compose build --no-cache && sudo -E docker compose up -d

staging_rabbitmq:
  stage: rabbitmq
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "rabbitmq/*"
        - "rabbitmq/*/*"
        - "rabbitmq/*/*/*"
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/rabbitmq && sudo -E docker compose build --no-cache && sudo -E docker compose up -d

production-pull-job:
  stage: production-pull
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
  tags:
    - production
  script:
    - echo "PULL JOB"
  after_script:
    - cd /home/admin/docker.collect.verything && sudo git reset --hard origin/production && sudo git pull origin production

production_image_php:
  stage: images
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "images/php8.1-fpm/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/images/php8.1-fpm && sudo docker build -t collectandverything-php .

production_image_nginx:
  stage: images
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "images/nginx-alpine/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/images/nginx-alpine && sudo docker build -t collectandverything-nginx .

production_image_react:
  stage: images
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "images/react/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/images/react && sudo docker build -t collectandverything-react .

production_build_address:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "address/*"
        - "address/*/*"
        - "address/*/*/*"
  environment:
    name: production
    url: https://production.api.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/address && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_address:
  stage: production-test
  needs: [production_build_address]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "address/*"
        - "address/*/*"
        - "address/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name address-test-php collectandverything-address:latest
    - sudo docker exec address-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f address-test-php

production_code_quality_address:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_address]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "address/*"
        - "address/*/*"
        - "address/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name address-test-php collectandverything-address:latest
    - sudo docker exec address-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp address-test-php:/var/www/output.xml phpcs-address.xml
  after_script:
    - sudo docker rm -f address-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_address:
  stage: production-scan
  needs: [production_build_address]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "address/*"
        - "address/*/*"
        - "address/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-address:latest

production_deploy_address:
  stage: production-deploy
  needs: [production_test_address]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "address/*"
        - "address/*/*"
        - "address/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/address && sudo -E docker compose up -d

production_build_admin:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "admin/*"
        - "admin/*/*"
        - "admin/*/*/*"
  environment:
    name: production
    url: https://production.api.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/admin && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_admin:
  stage: production-test
  needs: [production_build_admin]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "admin/*"
        - "admin/*/*"
        - "admin/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name admin-test-php collectandverything-admin:latest
    - sudo docker exec admin-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f admin-test-php

production_code_quality_admin:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_admin]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "admin/*"
        - "admin/*/*"
        - "admin/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name admin-test-php collectandverything-admin:latest
    - sudo docker exec admin-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp admin-test-php:/var/www/output.xml phpcs-admin.xml
  after_script:
    - sudo docker rm -f admin-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_admin:
  stage: production-scan
  needs: [production_build_admin]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "admin/*"
        - "admin/*/*"
        - "admin/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-admin:latest

production_deploy_admin:
  stage: production-deploy
  needs: [production_test_admin]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "admin/*"
        - "admin/*/*"
        - "admin/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/admin && sudo -E docker compose up -d

production_build_api:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "api/*"
        - "api/*/*"
        - "api/*/*/*"
  environment:
    name: production
    url: https://production.api.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/api && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_api:
  stage: production-test
  needs: [production_build_api]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "api/*"
        - "api/*/*"
        - "api/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name api-test-php collectandverything-api:latest
    - sudo docker exec api-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f api-test-php

production_code_quality_api:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_api]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "api/*"
        - "api/*/*"
        - "api/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name api-test-php collectandverything-api:latest
    - sudo docker exec api-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp api-test-php:/var/www/output.xml phpcs-api.xml
  after_script:
    - sudo docker rm -f api-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_api:
  stage: production-scan
  needs: [production_build_api]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "api/*"
        - "api/*/*"
        - "api/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-api:latest

production_deploy_api:
  stage: production-deploy
  needs: [production_test_api]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "api/*"
        - "api/*/*"
        - "api/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/api && sudo -E docker compose up -d

production_build_boutique:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "boutique/*"
        - "boutique/*/*"
        - "boutique/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/boutique && sudo cp env/.env.staging .env && sudo -E docker compose build --no-cache && sudo -E docker compose up -d

production_build_bill:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "bill/*"
        - "bill/*/*"
        - "bill/*/*/*"
  environment:
    name: production
    url: https://production.bill.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/bill && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_bill:
  stage: production-test
  needs: [production_build_bill]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "bill/*"
        - "bill/*/*"
        - "bill/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name bill-test-php collectandverything-bill:latest
    - sudo docker exec bill-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f bill-test-php

production_code_quality_bill:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_bill]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "bill/*"
        - "bill/*/*"
        - "bill/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name bill-test-php collectandverything-bill:latest
    - sudo docker exec bill-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp bill-test-php:/var/www/output.xml phpcs-bill.xml
  after_script:
    - sudo docker rm -f bill-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_bill:
  stage: production-scan
  needs: [production_build_bill]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "bill/*"
        - "bill/*/*"
        - "bill/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-bill:latest

production_deploy_bill:
  stage: production-deploy
  needs: [production_test_bill]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "bill/*"
        - "bill/*/*"
        - "bill/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/bill && sudo -E docker compose up -d

production_build_cart:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "cart/*"
        - "cart/*/*"
        - "cart/*/*/*"
  environment:
    name: production
    url: https://production.cart.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/cart && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_cart:
  stage: production-test
  needs: [production_build_cart]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "cart/*"
        - "cart/*/*"
        - "cart/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name cart-test-php collectandverything-cart:latest
    - sudo docker exec cart-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f cart-test-php

production_code_quality_cart:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_cart]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "cart/*"
        - "cart/*/*"
        - "cart/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name cart-test-php collectandverything-cart:latest
    - sudo docker exec cart-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp cart-test-php:/var/www/output.xml phpcs-cart.xml
  after_script:
    - sudo docker rm -f cart-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_cart:
  stage: production-scan
  needs: [production_build_cart]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "cart/*"
        - "cart/*/*"
        - "cart/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-cart:lates

production_deploy_cart:
  stage: production-deploy
  needs: [production_test_cart]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "cart/*"
        - "cart/*/*"
        - "cart/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/cart && sudo -E docker compose up -d

production_build_dashboard:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "dashboard/*"
        - "dashboard/*/*"
        - "dashboard/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/dashboard && sudo -E docker compose build --no-cache && sudo -E docker compose up -d

production_build_employee:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "employee/*"
        - "employee/*/*"
        - "employee/*/*/*"
  environment:
    name: production
    url: https://production.employee.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/employee && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_employee:
  stage: production-test
  needs: [production_build_employee]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "employee/*"
        - "employee/*/*"
        - "employee/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name employee-test-php collectandverything-employee:latest
    - sudo docker exec employee-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f employee-test-php

production_code_quality_employee:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_employee]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "employee/*"
        - "employee/*/*"
        - "employee/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name employee-test-php collectandverything-employee:latest
    - sudo docker exec employee-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp employee-test-php:/var/www/output.xml phpcs-employee.xml
  after_script:
    - sudo docker rm -f employee-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_employee:
  stage: production-scan
  needs: [production_build_employee]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "employee/*"
        - "employee/*/*"
        - "employee/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-employee:latest

production_deploy_employee:
  stage: production-deploy
  needs: [production_test_employee]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "employee/*"
        - "employee/*/*"
        - "employee/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/employee && sudo -E docker compose up -d

production_build_image:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "image/*"
        - "image/*/*"
        - "image/*/*/*"
  environment:
    name: production
    url: https://production.image.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/image && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_image:
  stage: production-test
  needs: [production_build_image]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "image/*"
        - "image/*/*"
        - "image/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name image-test-php collectandverything-image:latest
    - sudo docker exec image-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f image-test-php

production_code_quality_image:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_image]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "image/*"
        - "image/*/*"
        - "image/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name image-test-php collectandverything-image:latest
    - sudo docker exec image-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp image-test-php:/var/www/output.xml phpcs-image.xml
  after_script:
    - sudo docker rm -f image-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_image:
  stage: production-scan
  needs: [production_build_image]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "image/*"
        - "image/*/*"
        - "image/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-image:latest

production_deploy_image:
  stage: production-deploy
  needs: [production_test_image]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "image/*"
        - "image/*/*"
        - "image/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/image && sudo -E docker compose up -d

production_build_mail:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "mail/*"
        - "mail/*/*"
        - "mail/*/*/*"
  environment:
    name: production
    url: https://production.mail.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/mail && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_mail:
  stage: production-test
  needs: [production_build_mail]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "mail/*"
        - "mail/*/*"
        - "mail/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name mail-test-php collectandverything-mail:latest
    - sudo docker exec mail-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f mail-test-php

production_code_quality_mail:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_mail]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "mail/*"
        - "mail/*/*"
        - "mail/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name mail-test-php collectandverything-mail:latest
    - sudo docker exec mail-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp mail-test-php:/var/www/output.xml phpcs-mail.xml
  after_script:
    - sudo docker rm -f mail-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_mail:
  stage: production-scan
  needs: [production_build_mail]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "mail/*"
        - "mail/*/*"
        - "mail/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-mail:latest

production_deploy_mail:
  stage: production-deploy
  needs: [production_test_mail]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "mail/*"
        - "mail/*/*"
        - "mail/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/mail && sudo -E docker compose up -d

production_build_order:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "order/*"
        - "order/*/*"
        - "order/*/*/*"
  environment:
    name: production
    url: https://production.order.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/order && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_order:
  stage: production-test
  needs: [production_build_order]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "order/*"
        - "order/*/*"
        - "order/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name order-test-php collectandverything-order:latest
    - sudo docker exec order-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f order-test-php

production_code_quality_order:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_order]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "order/*"
        - "order/*/*"
        - "order/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name order-test-php collectandverything-order:latest
    - sudo docker exec order-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp order-test-php:/var/www/output.xml phpcs-order.xml
  after_script:
    - sudo docker rm -f order-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_order:
  stage: production-scan
  needs: [production_build_order]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "order/*"
        - "order/*/*"
        - "order/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-order:latest

production_deploy_order:
  stage: production-deploy
  needs: [production_test_order]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "order/*"
        - "order/*/*"
        - "order/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/order && sudo -E docker compose up -d

production_build_product:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "product/*"
        - "product/*/*"
        - "product/*/*/*"
  environment:
    name: production
    url: https://production.product.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/product && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_product:
  stage: production-test
  needs: [production_build_product]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "product/*"
        - "product/*/*"
        - "product/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name product-test-php collectandverything-product:latest
    - sudo docker exec product-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f product-test-php

production_code_quality_product:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_product]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "product/*"
        - "product/*/*"
        - "product/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name product-test-php collectandverything-product:latest
    - sudo docker exec product-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp product-test-php:/var/www/output.xml phpcs-product.xml
  after_script:
    - sudo docker rm -f product-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_product:
  stage: production-scan
  needs: [production_build_product]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "product/*"
        - "product/*/*"
        - "product/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-product:latest

production_deploy_product:
  stage: production-deploy
  needs: [production_test_product]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "product/*"
        - "product/*/*"
        - "product/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/product && sudo -E docker compose up -d

production_build_store:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "store/*"
        - "store/*/*"
        - "store/*/*/*"
  environment:
    name: production
    url: https://production.store.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/store && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_store:
  stage: production-test
  needs: [production_build_store]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "store/*"
        - "store/*/*"
        - "store/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name store-test-php collectandverything-store:latest
    - sudo docker exec store-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f store-test-php

production_code_quality_store:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_store]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "store/*"
        - "store/*/*"
        - "store/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name store-test-php collectandverything-store:latest
    - sudo docker exec store-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp store-test-php:/var/www/output.xml phpcs-store.xml
  after_script:
    - sudo docker rm -f store-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_store:
  stage: production-scan
  needs: [production_build_store]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "store/*"
        - "store/*/*"
        - "store/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-store:latest

production_deploy_store:
  stage: production-deploy
  needs: [production_test_store]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "store/*"
        - "store/*/*"
        - "store/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/store && sudo -E docker compose up -d

production_build_user:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "user/*"
        - "user/*/*"
        - "user/*/*/*"
  environment:
    name: production
    url: https://production.user.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/user && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_user:
  stage: production-test
  needs: [production_build_user]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "user/*"
        - "user/*/*"
        - "user/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name user-test-php collectandverything-user:latest
    - sudo docker exec user-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f user-test-php

production_code_quality_user:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_user]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "user/*"
        - "user/*/*"
        - "user/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name user-test-php collectandverything-user:latest
    - sudo docker exec user-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp user-test-php:/var/www/output.xml phpcs-user.xml
  after_script:
    - sudo docker rm -f user-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_user:
  stage: production-scan
  needs: [production_build_user]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "user/*"
        - "user/*/*"
        - "user/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-user:latest

production_deploy_user:
  stage: production-deploy
  needs: [production_test_user]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "user/*"
        - "user/*/*"
        - "user/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/user && sudo -E docker compose up -d

production_build_payment:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "payment/*"
        - "payment/*/*"
        - "payment/*/*/*"
  environment:
    name: production
    url: https://production.payment.collectandverything.fr
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/payment && sudo cp env/.env.production .env && sudo -E docker compose build --no-cache

production_test_payment:
  stage: production-test
  needs: [production_build_payment]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "payment/*"
        - "payment/*/*"
        - "payment/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name payment-test-php collectandverything-payment:latest
    - sudo docker exec payment-test-php /bin/bash -c 'php artisan test'
  after_script:
    - sudo docker rm -f payment-test-php

production_code_quality_payment:
  stage: production-code-quality
  allow_failure: false
  needs: [production_build_payment]
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "payment/*"
        - "payment/*/*"
        - "payment/*/*/*"
  tags:
    - production
  script:
    - sudo docker run -d --network=collectandverything --name payment-test-php collectandverything-payment:latest
    - sudo docker exec payment-test-php /bin/bash -c 'phpcs --standard=PSR12 app/ > output.xml || true'
    - sudo docker cp payment-test-php:/var/www/output.xml phpcs-payment.xml
  after_script:
    - sudo docker rm -f payment-test-php
  artifacts:
    paths:
      - "*.xml"

production_scan_payment:
  stage: production-scan
  needs: [production_build_payment]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "payment/*"
        - "payment/*/*"
        - "payment/*/*/*"
  tags:
    - production
  script:
    - sudo trivy image --severity CRITICAL,HIGH collectandverything-payment:latest

production_deploy_payment:
  stage: production-deploy
  needs: [production_test_payment]
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "payment/*"
        - "payment/*/*"
        - "payment/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/payment && sudo -E docker compose up -d

production_build_vitrine:
  stage: production-build
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "vitrine/*"
        - "vitrine/*/*"
        - "vitrine/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/vitrine && sudo -E docker compose build --no-cache && sudo -E docker compose up -d

production_rabbitmq:
  stage: rabbitmq
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "rabbitmq/*"
        - "rabbitmq/*/*"
        - "rabbitmq/*/*/*"
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/rabbitmq && sudo -E docker compose build --no-cache && sudo -E docker compose up -d

production_proxy:
  stage: proxy
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "production"
      changes:
        - "proxy/*"
        - "proxy/*/*"
        - "proxy/*/*/*"
  environment:
    name: production
  tags:
    - production
  script:
    - cd /home/admin/docker.collect.verything/proxy && sudo -E docker compose build --no-cache && sudo -E docker compose up -d
  when: manual

staging_proxy:
  stage: proxy
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH == "staging"
      changes:
        - "proxy-staging/*"
        - "proxy-staging/*/*"
        - "proxy-staging/*/*/*"
  environment:
    name: staging
  tags:
    - staging
  script:
    - cd /home/admin/docker.collect.verything/proxy-staging && sudo -E docker compose build --no-cache && sudo -E docker compose up -d
  when: manual

after_script:
  - cd /home/admin/docker.collect.verything && sudo docker image prune --force